@page "/"
@attribute [Authorize]
@implements IAsyncDisposable
@inject IJSRuntime JS
@inject WiccapediaGrimoire.Services.Covers.CoversService CoversService

<PageTitle>Cover</PageTitle>

<div class="alert alert-warning" role="alert">
    Before authentication will function correctly, you must configure your provider details in <code>Program.cs</code>
    <br />
    This cover animation runs purely in C# using Blazor and Canvas2D, no JavaScript.
</div>

<div class="position-relative">
    <!-- Full-screen-ish canvas area; using fixed size to avoid JS measurements -->
    <div style="position:absolute;inset:0;z-index:2;">
    </div>
    <div @ref="animationContainer" class="animation-container"></div>
</div>


<h1>Hidden</h1>

@code {
    private ElementReference animationContainer;
    private IJSObjectReference? module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Import the collocated JS module
            module = await JS.InvokeAsync<IJSObjectReference>("import", "./Pages/Home.razor.js");

            var defaultCover = await CoversService.GetDefaultCoverAsync();
            if (defaultCover != null)
            {
                // Load and play Lottie animation using the exported function
                await module.InvokeVoidAsync("startLottieAnimation", animationContainer, defaultCover.LottieData);
            }
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (module is not null)
        {
            await module.DisposeAsync();
        }
    }
}